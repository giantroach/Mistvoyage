# 要件
- テキストがメインのオフラインゲームを制作します。
- 原則としてWeb開発とし、github pagesでアクセスでき、localstorageにセーブデータを保存します。
- 最終的にはmobile appとしてコンパイルし、リリースできると良いです。
- 原則としてバックエンドは使用しません。ウェブブラウザ内で完結します。
- 設定ファイルはjson形式とし、このjsonを編集することでコンテンツの追加が出来るものとします。

# ゲームの概要
- これはテキストベースのローグライトゲームです。
- ストーリーはほぼありません。
- ゲームは3つのチャプターに分かれており、各チャプターで異なる難易度の海域を旅します。
- 各チャプターでは規定数の「イベント」こなすことで「ボスイベント」に対峙します。
- 各チャプターでは事前に「スタート地点」から「最終イベント」までのツリー構造のようなマップが構築されます。ただし各枝は最大3つであり、「スタート地点」と「最終イベント」で一つに収束します。
- プレイヤーはSight値に応じてこのマップの一部を見ることができます(最大で2つ先まで)。
- イベントには「戦闘イベント」「航海イベント」「エンカウンターイベント」「飢餓イベント」など様々なものがあり、その種類、内容、発生条件などがJSONで定義されます。この定義を更新することで無限にゲームが拡張できるものとします。
- 各イベントにはイベントタイプと難易度が設定されており、プレイヤーは提示される最大三つのイベントからEncounterする任意のものを選択します。この際、プレイヤーが見られるのはイベントタイプのみです。ただし、イベント難易度に対し、Sightパラメターが低すぎる場合、イベントタイプは表示されず「???」が代わりに表示されます。
- 戦闘は原則としてオートバトルとし、戦闘中はプレイヤーが操作することはできません。戦闘ログやパラメータの増減を楽しみます。
― 「港イベント」では買い物や船の修理が行えます。
― 幾つかのイベントはSequencialであり、最初のイベントの選択肢に応じて後続のイベントが、ゲーム中のランダムなタイミングで発生します。またそのようなイベントが定義できるものとします。

# Parameter
プレイヤーには以下のパラメータがあり、その一部はプレイヤーに開示され、その一部は内部的にのみ使用される。
開示されるパラメータは画面上部に簡易的に表示される。

## Ship
- 公開パラメータ
- ゲーム開始時に選択し、ゲーム中に変更されることは原則としてない。ごく特殊なイベントによる変更は認める。
- Shipごとに後述のHull, Crewの上限とSpeed、Storage、Weapon Slot、Weaponが設定されている。
- Shipごとに特殊なルールをもつ事がある。
― 初期ShipのHullの上限は100, Crewの上限は10。Storageは8。Weapon slotは2。WeaponはHarpoon。

## Hull
- 公開パラメータ
- HPにあたるもの。0になるとゲームオーバー。
- 港で修理をすることで回復が出来る。

## Speed
― 非公開パラメータ
- イベントで参照される。
- Crew数に応じて補正される。
― 天候により補正される。

## Storage
- 公開パラメータ。
- イベント等で入手できるRelicを幾つ保持できるかの値。

## Food
- 公開パラメータ
― 毎ラウンド消費するほか、特定のイベントで増減する。
- 港で購入が出来る。
- 0になると即座にはゲームオーバーにならないものの、ネガティブな特殊イベントが発生するようになり、急速にゲームオーバーに近づく。
- 初期値は20。

## Money
― 公開パラメータ。
- 港で修理やFoodの購入に使用される。
- モンスターの撃破や特定のイベントにより増減する。
- 初期値は50。

## Crew
- 公開パラメータ
- 値が低くなるほど
- 0になるとゲームオーバー。

## Sight
― 公開パラメータ
― 船の進路を決定する際やイベント時に参照される。
- Crew数に応じて補正される。
- 天候により補正される。

## Weather
― 公開パラメータ
- Sight値やSpeed値に影響する。
― イベントで参照される。

## Karma
- 非公開パラメータ
― 悪いイベントをこなすごとに値が増え、良いイベントが発生する確立が上がる。
- 良いイベントをこなすごとに値が減り、悪いイベントが発生する確立が増える。

## Relic
- 公開パラメータ
― 装備品のようなもので、様々なパラメータに作用する。

## Weapon Slot
― 公開パラメータ
- Weaponを幾つ装備できるかの値。

## Weapon
― 公開パラメータ
- 戦闘で参照される。

# マップ
- マップはチャプター開始時にランダムに生成されます。
- マップはイベントの集合であり、各イベントは最大3つの枝を持つツリー構造となっています。
- マップは常に「スタート地点」から始まり、「ボスイベント」に収束して終わります。
- マップは「イベント」のタイプのみがアサインされ、実際のイベントはプレイヤーの選択時にランダムに選択されます。
- プレイヤーは周辺の海域のイベントを上部のメニューから最大で3つ先まで見ることができます。
- イベントのタイプは以下の通りです。
    - 「???」: 何が起こるか分かりません。
    - 「モンスター」: 戦闘になります。勝利することで「金」や、低確率で「武器」や「レリック」を入手できます。
    - 「エリートモンスター」: 通常より強力なモンスターと戦闘になります。勝利することで「武器」や「レリック」入手できます。
    - 「港」：港へ立ち寄り、「武器」や「レリック」の買い物や修理が行えます。
    - 「ボス」：チャプターの終わりに配置されるボスとの戦闘イベントです。
    - 「スタート地点」: チャプターのスタート地点です。特に効果はありません。
    - 「宝」: レリックを入手できるイベントです。
- 各イベントの出現頻度はJSONファイルで定義できるものとします。game.jsonとはファイルを分け、また海域ごとに設定が出来るような構造にしてください。
- 「港」は固定回数出現し、「???」は高確率で発生、「宝」は低確率で発生するという具合に定義できるものとします。
- チャプターごとに必用イベント数もこの定義jsonに定義するようにします。

## 追加要件1
- マップ上のイベントを次のレイヤの一つ以上のイベントと線でつなげてください。また、線でつながったイベントしか選択出来なくしてください。
- 各レイヤには最大4つのイベントを配置してください。また手前のレイヤーから線の繋がっていないorphanが起きないようにしてください。
- スクロールにより最終レイヤまで線のつながりを確認できるようにしてください。ただし、3つ以上先のレイヤのイベントタイプは「???」でマスクしてください。

## 追加要件2
- マップの生成時、レイヤ内に2つ以上ノードがある場合、その全てが同じイベントタイプにならないようにします。
- 「エリートモンスター」イベントはスタートノードから2マス以内には配置されません。また各海域に最低幾つ、最大幾つ配置されるか、海域の設定にて定義します。
- 「宝」に関しても海域の設定にて最低幾つ、最大幾つを定義します。

# 天候
- 天候は時間(ゲームの進行)とともに悪化する。
- 「快晴」から始まり、「曇り」になり、その後「雨」→「嵐」や「霧」→「濃霧」のよう悪化しける。
    - 内部的には天候は以下の二つのパラメータで表現される。
        - weather: 数値データ。0 (快晴)からスタートし、5で曇りとなる。
            - 10に達すると「type」値がランダムに決定される。
            - 10を下回ると「type」値をリセットする。
            - 最大値は20
            - イベントを選択するたびにこの値が+1される。
            - 20に達すると「type」に関わらず「嵐」となる。
        - type: 文字データ。"" (未設定)からスタートし、「weather」が10に達した時ランダムに値が設定される。
            - fog: 天候が「霧」となる。weather値が15に達すると天候が「濃霧」となる。
            - rain: 天候が「雨」となる。weather値が15に達すると天候が「大雨」となる。
- 天候による影響はプレイヤーのみ受ける。
- 「雨」と「大雨」は「速度」「命中率」に悪影響を及ぼす。
     - 雨: 速度 -1, 命中率 -10%
     - 大雨: 速度 -2, 命中率 -20%
- 「霧」と「濃霧」は「命中率」と「視界」に悪影響を及ぼす。
     - 霧: 命中率 -15%, 視界: -5
     - 濃霧: 命中率 -30%, 視界: -10
- 「嵐」は「速度」「命中率」「視界」に悪影響を及ぼす。
     - 濃霧: 速度: -2, 命中率 -30%, 視界: -10

# 所持品

## 武器
- 武器は weapons.json ファイルに定義されている。
- プレイヤーは1つ以上の武器を持つ。
- プレイヤーが持てる武器の数は Ship に定義されたWeapon Slotに準ずる。
    - 複数の武器を持つ場合、それぞれの武器がクールダウンを持ち、並列で攻撃が行える。
- レリックは「港」イベントで購入できるほか、「宝」イベントや「エリートモンスター」撃破時にも獲得できる。
- プレイヤーは画面上の武器をクリックすることで武器の詳細画面を開くことができる。
- 武器には以下のパラメータがある。
    - damage
        - 2-6のようにレンジで指定される。攻撃命中時にこの範囲のランダムな値がダメージとして与えられる。
    - handlingReq
        - 武器を使用するため必用なcrew数。
        - 3のように非レンジで指定される。
        - 全部の武器のhandlingReqの合計が現在のcrew数より多い場合、全ての武器のcooldownに足りないcrew数×10%のペナルティが課せられる。
    - accuracy
    - cooldown
        - 2000-3000のようにmsecで定義される。
        - handlingReqや天候によりペナルティが課せられる。
    - description
    - critRate
        - 攻撃の命中時、この確立で Critical hit が発生し、 critMultiplier倍のダメージを与える。
    - critMultiplier
        - Critical hit時にこの倍率のダメージを与える。
    - price
- レリックにはレアリティが設定されており、低いものから「コモン」「アンコモン」「レア」「エピック」「レジェンダリ」となっている。
- 「price」を除く各パラメターは各武器に定義された範囲でランダムに決定される。この範囲は各レアリティごとに異なる。
- 「price」は各レアリティに定義されており、price以外の各パラメータで範囲の上限に近いものが多いほど、この値に近いものとなる。
    - 逆に下限に近いパラメターが多いほどprice定義の50%に近い値となる。
- 初期装備は常に「コモン」レアリティとなる。
    - またフルpriceからの差分初時期として還元される。
- 武器は「港」イベントで購入できるほか、「モンスター」イベントや「エリートモンスター」撃破時にも獲得できる。

## レリック
- レリックは relics.json ファイルに定義されている。
- プレイヤーは0つ以上のレリックを持つ。
- プレイヤーが所持できるレリックの数は原則としてShipに定義されたStorage数に準じる。
- レリックは「港」イベントで購入できるほか、「宝」イベントや「エリートモンスター」撃破時にも獲得できる。
- レリックには様々な効果がある。複数の効果を持つレリックも存在する。
- レリックの効果はランダムに決定される。2つ以上の効果を持つことがある。
- レリックの効果は変動部を持つことがあり、その変動部は入手時にランダムに決定される。
    - 例えば「- {パラメータ名} を +{N} する。」の効果であれば「パラメータ名」「N」がそれぞれ変動部である。
- レリックにはレアリティが設定されており、低いものから「コモン」「アンコモン」「レア」「エピック」「レジェンダリ」となっている。
- レリックの効果の変動部はレアリティに応じて下限値と上限値が設定されている。
    - 変動部の設定は効果ごとに定義される。
- レリックのレアリティに応じて、効果の最大数が異なる。
    - コモン: 1つ
    - アンコモン: 1つ～2つ
    - レア: 1つ～3つ
    - エピック: 2つ～3つ
    - レジェンダリ: 3つ。ただしそのうち一つは特殊なレジェンダリ効果である。
- 「レジェンダリ」レリックには通常のレリックにない効果を一つ持つ。

### 通常レリックの効果
- ShipのStorageを{N}拡張する。
- Weapon Slotを{N}拡張する。
- {パラメータ名} を +{N} する。
- 戦闘後に入手できる金が+{N}%される。

### レジェンダリレリックの効果
- 戦闘開始後 {N}秒館 {パラメータ名} が50%になるが、その後 {パラメータ名} が300% になる。
- 武器として機能する(Weapon Slotは消費しない)

# イベント

## 宝
- 三つのランダムなレリックから、任意の一つをプレイヤーが選択し、獲得する。
- 提示されるレリックのレアリティとその確率は各海域の定義ファイルに定義される。

## 港
- 港では以下の三つのサービスを任意の回数、使用することが出来る。
    - 船体の修復: 金と引き換えに船体を10修復する。必用な金額は各海域の定義ファイルに定義されている
    - 武器の購入: ランダムに提示される3つの武器から任意のものを任意の数、購入できる。
        - ただし最初に提示された3つ以外のもは提示されない。
        - 提示される武器のレアリティは chapters.json に海域ごとに定義される。
    - レリックの購入: ランダムに提示される3つのレリックから任意のものを任意の数、購入できる。
        - ただし最初に提示された3つ以外のもは提示されない。
        - 提示されるレリックのレアリティは chapters.json に海域ごとに定義される。

## 寺院
- 寺院では天候を回復することが出来る。
- 寺院で「祈りを捧げる」ことで、weather値を0に、typeを""にセットする。
- 寺院イベントは1海域に1つ以上生成される。

## モンスター
- モンスタータイプのイベントノードを選択後、モンスターとの戦闘が発生します。
- 出現するモンスターは海域に定義されたモンスターからランダムにピックされます。
- モンスターは1-3体出現します。これらの組み合わせも海域に定義されるものとします。
- 戦闘はオートバトルで行われます。
- プレイヤーは戦闘ログから戦いの進行を観測します。
- 各武器にはクールダウンがあり、クールダウン後自動的に使用されます。
    - Crew数に応じてクールダウンに補正が入ります。Crew数が船の上限の半分より少ない場合、クールダウンが徐々に増えます。
- 各武器には命中精度があり、その確立を元に、幾つかの補正をもって最終的な命中率が計算されます。
    - モンスターのスピードと船のスピードを比較し、自分側が遅い場合は命中率が下がります。逆に自分が早い場合は命中率が上がります。
    - Sight値(天候による補正を加味した)を確認し、規定値より低い場合は命中率が下がります。
- 各武器にはダメージのレンジの設定があり、たとえば「2-6」であれば2から6の間のランダムな値がダメージとなります。
- プレイヤーは複数の武器を扱う事が出来ます。各武器の命中率はクールダウンは独立しています。
- モンスターもプレイヤーと原則として同様の判定を行います。
    - ただし、モンスターにはCrew数がないため、ライフの残量を参照します。
    - ライフの残量が減るほどモンスターは狂暴化し、クールダウンが減り、命中精度が落ちます。
- モンスターのHPはバーチャートで表示してください。具体的な数字は表示しないでください。
- モンスターを撃破後、金を獲得します。
    - 金以外も今後獲得できるようにしますがひとまずは金だけを実装します。
- 各補正値は今後調整することとなるのでコンフィグファイルに分けてください。

## ボス
- ボスモンスターと戦闘が発生する。
- ボスモンスターは海域の定義ファイルに定義されたボスモンスターと戦闘になる。
- ボスモンスターとの戦闘の流れは通常のモンスターとの戦闘とほぼ同じである。
- ボスモンスターを撃破すると通常のリワードの代わりに、海域の定義に定義されたレアリティの3つのレリックの中から一つを選んで獲得できる。
- レリックの選択後、次のチャプターへと進む。

# デバッガ―
- 「船」「武器」「レリック」「モンスター」の実装やバランスを確認するためのデバッグ画面。
- 画面最上部のメニューからアクセスする。
- 以下を選択し、戦闘のシミュレーションが行える。
    - 「船」
    - 「crew」
        - 現在のcrew数を数字で指定する。
    - 「武器」
        - 「武器名」「レアリティ」を選択した上で生成ボタンを押すことで武器を生成する。
        - 複数の「武器」を選択＆生成可能。
        - 削除ボタンにより生成済みの武器を削除できる。
    - 「レリック」
        - 「レアリティ」を選択した上で生成ボタンを押すことでレリックを生成する。
        - 複数の「レリック」を選択＆生成可能。
        - 削除ボタンにより生成済みのレリックを削除できる。
    - 「モンスター」
- 「戦闘」ボタンを押すことで戦闘が出来る。これは通常の「モンスター」イベントと同じロジックを使用する。
